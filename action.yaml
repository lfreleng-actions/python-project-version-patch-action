---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025 The Linux Foundation

# python-project-version-patch-action
name: 'ðŸ Patch the Python Project Version'
description: 'Replaces/updates the Python project version string'
# Note: works with both pyproject.toml and setup.py

inputs:
  # Mandatory
  replacement_version:
    description: 'Replacement project version string'
    required: true
    # type: string
  path_prefix:
    description: 'Directory location containing project code'
    required: false
    default: '.'
    # type: string

runs:
  using: 'composite'
  steps:
    - name: 'Verify valid directory path'
      shell: bash
      run: |
        # Verify valid directory path
        if [ ! -d "${{ inputs.path_prefix }}" ]; then
          echo 'Error: invalid path/prefix to project directory âŒ'; exit 1
        fi

    - name: 'Normalize and validate version'
      id: normalize
      shell: bash
      run: |
        set -euo pipefail
        # Normalize and validate version

        input_version="${{ inputs.replacement_version }}"
        echo "Input version: $input_version"

        # Strip leading 'v' or 'V' if present (common in Git tags)
        normalized_version="${input_version#[vV]}"

        # Validate that the normalized version is not empty
        if [ -z "$normalized_version" ]; then
          echo "Error: Version string is empty after normalization" >&2
          exit 1
        fi

        # Basic PEP 440 validation (X.Y.Z, X.Y.Z.dev0, X.Y.ZaN, etc.)
        pep440_pattern='^[0-9]+(\.[0-9]+)*((a|b|rc)[0-9]+)?(\.dev[0-9]+)?(\.post[0-9]+)?$'
        if ! echo "$normalized_version" | grep -qE "$pep440_pattern"; then
          echo "Warning: Version may not be PEP 440 compliant" >&2
          echo "Proceeding anyway, but this may cause issues" >&2
        fi

        echo "Normalized version: $normalized_version"
        echo "normalized_version=$normalized_version" >> "$GITHUB_OUTPUT"

    # yamllint disable-line rule:line-length
    - uses: lfreleng-actions/path-check-action@9606e61c870025bc956e63156d1d55c5df54426c  # v0.2.0
      id: setup-py
      with:
        path: "${{ inputs.path_prefix }}/setup.py"

    # yamllint disable-line rule:line-length
    - uses: lfreleng-actions/path-check-action@9606e61c870025bc956e63156d1d55c5df54426c  # v0.2.0
      id: pyproject-toml
      with:
        path: "${{ inputs.path_prefix }}/pyproject.toml"

    - name: 'Patch Python project version: setup.py'
      id: patch-version-setup-py
      if: steps.setup-py.outputs.type == 'file'
      # yamllint disable-line rule:line-length
      uses: lfreleng-actions/file-sed-regex-action@e2c1c94d7936e1ded3e5fa8109416383f472ef7c # v0.1.2
      with:
        flags: '-i -E'
        # yamllint disable-line rule:line-length
        regex: '/^[[:space:]]*version[[:space:]]*=.*$/{ s//version="${{ steps.normalize.outputs.normalized_version }}"/; t found; }; $ { b notfound; }; b; :found q0; :notfound q1'
        path: "${{ inputs.path_prefix }}/setup.py"
        debug: true

    - name: 'Patch Python project version: pyproject.toml'
      id: patch-version-pyproject-toml
      if: steps.pyproject-toml.outputs.type == 'file'
      # yamllint disable-line rule:line-length
      uses: lfreleng-actions/file-sed-regex-action@e2c1c94d7936e1ded3e5fa8109416383f472ef7c # v0.1.2
      with:
        flags: '-i -E'
        # yamllint disable-line rule:line-length
        regex: '/^version =.*$/{ s//version = "${{ steps.normalize.outputs.normalized_version }}"/; t found; }; $ { b notfound; }; b; :found q0; :notfound q1'
        path: "${{ inputs.path_prefix }}/pyproject.toml"
        debug: true
        # yamllint enable rule:line-length
